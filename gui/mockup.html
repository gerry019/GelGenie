<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/de3426f84b.js" crossorigin="anonymous"></script>
    
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    
    <!-- Bootstrap Bundle with Popper / Javascript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    
    <!-- Own CSS -->
    <link href="static/stylesheet.css" type="text/css" rel="stylesheet">

    <!-- Own Javascript -->
    <script src="main.js"></script> 
    
    <title>Automatic Gel Analysis</title>
  </head>
  <body>
  
    <script src="https://cdn.socket.io/4.1.2/socket.io.min.js" integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous"></script>
    
    
    <script>
      const socket = io("http://localhost:8080");
      
      function previewFile() {
        var preview = document.querySelector('img');
        var file    = document.querySelector('input[type=file]').files[0];
        var reader  = new FileReader();
        
        
        reader.onloadend = function () {
          let sourceImage = reader.result;
          preview.src = sourceImage;
          let base64Img = sourceImage.substr(23);
          console.log(base64Img);
          socket.emit("imageToRead", base64Img);
        }
        if (file) {
          reader.readAsDataURL(file);
          var loadImgCont = document.getElementById("loadImgCont");
          loadImgCont.style.display = "none";  // Hide the select image container
          secondScreen.style.display = "block";   // Show the container with image
        } else {
          preview.src = "";
        }        
      }
      
      socket.on("sourceInJpg", function(data) {
        var preview = document.getElementById('previewImg');
        preview.src = 'data:image/png;base64,'.concat(data);
        console.log("SOURCE IN JPG IS ACTIVE");
      });
      
      
      // When bands have been found
      socket.on("viewResult", function(data) {
        // Show the image with found bands in the browser
        var preview = document.getElementById('previewImg');
        preview.src = 'data:image/png;base64,'.concat(data["file"]);
        band_props = JSON.parse(data.props);
        band_centroids = JSON.parse(data.centroids);
        band_areas = JSON.parse(data.areas);
        band_w_areas = JSON.parse(data.w_areas);
        band_bboxs = JSON.parse(data.bboxs);
        console.log(band_props);
        var base64_string = data["file"];
        
        
        // Find image size
        var image_height = data.im_height;
        console.log(image_height);
        var image_width = data.im_width;
        console.log(image_width);
        
        // Create band rectangles for each band
        for (let i = 0; i < band_centroids.length; i++){
        
          // Find width of each band
          let band_width = band_bboxs[2] - band_bboxs[0];
          let band_height = band_bboxs[3] - band_bboxs[1];
        
        
          console.log(band_centroids[i][0]);
          // Find x and y coords of band centroids
          let band_y_px = band_centroids[i][0];
          let band_x_px = band_centroids[i][1];
          
          let band_y_100 = ((band_y_px-10) / image_height * 100).toString()
          band_y_100 = band_y_100.concat("%");
          
          let band_x_100 = ((band_x_px-20) / image_width * 100).toString();
          band_x_100 = band_x_100.concat("%");
          
          current_id = "band_".concat(i);
          // Create the button
          $("#band-rectangles").append('<button type="button" id="' + current_id + '"  class="btn btn-outline-primary" style = "width:' + band_width + ', height:' + band_height + '"></button>');
          // Find the button's position
                    
          // Position the button
          console.log(band_y_100);
          $("#" + current_id).css({top: band_y_100, left: band_x_100, position:'absolute'});
          
          // Add event listener to button
          $("#" + current_id).click(function(){
            bandClick(i);
            })
        }
        
                        
        /*
        // var reader  = new FileReader();
        // reader.readAsDataURL("../results/result1.jpg");
        
        reader.onloadend = function () {
          // preview.src = reader.result;
          // var image = new Image();
          
        } */
        
      });
      
      function bandClick(bandNo){
        console.log("The band area is " + band_areas[bandNo]);
        $("#band-area").html(band_areas[bandNo]);
        $("#w-band-area").html(band_w_areas[bandNo]);
      }
      
    </script>
    
    
  
    <!-- Top menu -->
    <nav class="navbar navbar-dark bg-dark fixed-top">
      <div class="container-fluid justify-content-start">
        <div class="col-1"></div>
        <!-- General buttons -->
        <button class="btn btn-dark me-2 new" type="button"><span class="fas fa-file"></span></button>
        <button class="btn btn-dark me-2 open" type="button"><span class="fas fa-folder-open"></span></button>
        <button class="btn btn-dark me-2 save" type="button"><span class="fas fa-save"></span></button>
        <button class="btn btn-dark me-2 export" type="button"><span class="fas fa-file-export"></span></button>
        <div class="col-1"></div>
        <!-- Band buttons -->
        <button class="btn btn-dark me-2 find" type="button"><span class="fas fa-search"></span></button>
        <button class="btn btn-dark me-2 add-bands" type="button"><span class="fas fa-plus"></span></button>
        <button class="btn btn-dark me-2 remove-bands" type="button"><span class="fas fa-times"></span></button>
        <div class="col-1"></div>
        <button class="btn btn-dark me-2 settings" type="button"><span class="fas fa-cog"></span></button>
      </div>
    </nav>
    
    <!-- Loaded image display (this is hidden until the user selects an image -->
    <div id="secondScreen" style="display: block" class="container">
      <div class="row justify-content-around">
        <div id="loadedImg" style="position: relative" class="mt-5 p-2 bg-dark col-7 border">
          <img id="previewImg" src="2_A_result.jpg" alt="" class ="img-fluid mx-auto d-float" width="100%"/>
          <div id="band-rectangles" style="position: absolute; top:0px; left: 0; bottom: 0; right: 0; width: 100%">
          </div>
        </div>
        
        <div id="lanePlot" class="mt-5 p-2 col-2 bg-light">
          <img id="intPlot" src="mockup_intplot.png" class="img-fluid mx-auto d-float" width="100%"/>
        </div>
        
        <div class="mt-5 p-2 col-2">
          <table id="bandData" class="table table-dark">
            <thead></thead>
            <tbody>
              <tr>
                <th scope="row">Band Area</th>
                <td id="band-area">1009</td>
                <td>px</td>
              </tr>
              <tr>
                <th scope="row">Weighted Band Area</th>
                <td id="w-band-area">874</td>
                <td>px</td>
              </tr>
              <tr>
                <th scope="row">Calibrated Band Area</th>
                <td id="w-band-area" contenteditable="true">0.100</td>
                <td>ml</td>
              </tr>
              <tr>
                <th scope="row"><button class="btn btn-light me-2" type="button">Set known quantity</button></th>
                <td id="w-band-area"></td>
                <td>ml</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Open an image section (this is displayed until an image is loaded, then hidden) -->
    <div id="loadImgCont" style="display: none" class="container mt-5 p-4 bg-dark col-5 rounded-3 border border-2">
      <h3>Choose an image to analyze</h3>
      <form id="form1">
        <div class="custom-file">
          <input type="file" class="custom-file-input" name="photo" onchange="previewFile(this);" required>
          
        </div>
      </form>
    </div>
    
  </body>
</html>
